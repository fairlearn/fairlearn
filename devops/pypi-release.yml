variables:
  poolImage: "ubuntu-latest"
  poolPythonVersion: 3.6

trigger: none # No CI build

pr: none # Not for pull requests


stages:
- stage: PreUnit
  dependsOn: []
  pool:
    vmImage: $(PoolImage)
    
  jobs:
  - template: all-tests-job-template.yml
    parameters:
      name: Linux
      vmImage: 'ubuntu-16.04' # Will want to add other platforms and pyVersions back in eventually
      pyVersions: [3.6] 

- stage: PreNotebooks
  dependsOn: []
  pool:
    vmImage: $(PoolImage)

  jobs:
  - template: notebook-job-template.yml
    parameters:
      name: LinuxNotebooks
      vmImage: 'ubuntu-16.04'

- stage: CreateTestPyPIPackage
  dependsOn:
  - PreUnit
  - PreNotebooks

  jobs:
  - job: Create_PyPI_Test_Package
    pool:
      vmImage: $(PoolImage)

    steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(poolPythonVersion)'
      inputs:
        versionSpec: $(poolPythonVersion)
        addToPath: true
    
    - script: pip install setuptools wheel 
      displayName: 'Install setuptools'

    - script: pip install -r requirements.txt
      displayName: "Install fairlearn requirements"

    - task: PowerShell@2
      inputs:
        filePath: scripts/build-test-wheels.ps1
        pwsh: true

    - task: PublishPipelineArtifact@1
      inputs:
        path: $(System.DefaultWorkingDirectory)/dist
        artifact: TestPackages
      
- stage: DeployToPyPITest
  dependsOn: CreateTestPyPIPackage
  jobs:
  - deployment: "Deploy_to_PyPI_Test"
    environment: "PyPI-Test"
    pool:
      vmImage: $(PoolImage)

    strategy:
      runOnce:
       deploy:
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(poolPythonVersion)'
            inputs:
              versionSpec: $(poolPythonVersion)
              addToPath: true

          - script: pip install twine
            displayName: 'Install twine'

          - script: ls -R $(Pipeline.Workspace)
            displayName: "List files in Pipeline.Workspace"

          - script: echo "python twine upload --repository-url https://test.pypi.org/legacy/ $(Pipeline.Workspace)/TestPackages/*"

- stage: CheckTestPyPIPackage
  dependsOn: DeployToPyPITest

  jobs:
  - job: "Check_Test_Package"
    pool:
      vmImage: $(PoolImage)

    steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(poolPythonVersion)'
      inputs:
        versionSpec: $(poolPythonVersion)
        addToPath: true

    - script: cp -r $(Build.Repository.LocalPath)/test/unit/ $(Agent.TempDirectory)/
      displayName: "Copy Tests to temp directory"

    - script: cd $(Agent.TempDirectory)/
      displayName: "Move to temp directory"

    - script: ls -R
      displayName: "List files"

    - script: pip install -r requirements.txt
      displayName: "Install fairlearn requirements from regular PyPI"

    - script: pip install --index-url https://test.pypi.org/simple/ --no-deps fairlearn
      displayName: "Install fairlearn from PyPI-Test"
      